---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/layout/Header.astro';
import Footer from '@/components/layout/Footer.astro';
import Hero from '@/components/sections/Hero.astro';
import About from '@/components/sections/About.astro';
import Experience from '@/components/sections/Experience.astro';
import Projects from '@/components/sections/Projects.astro';
import Skills from '@/components/sections/Skills.astro';
import BlogPreview from '@/components/sections/BlogPreview.astro';
import Contact from '@/components/sections/Contact.astro';

type GithubEvent = {
  type: string;
  created_at: string;
  repo?: { name?: string };
  payload?: {
    commits?: { message?: string }[];
    pull_request?: { title?: string; html_url?: string };
    ref_type?: string;
    ref?: string;
    description?: string;
  };
};

type NormalizedActivity = {
  repo: string;
  message: string;
  link: string;
  date: string;
};

const MAX_ACTIVITY_MESSAGE_LENGTH = 88;

const normalizeMessage = (message: string): string => {
  const trimmedPrefix = message
    .replace(/^(?:merge pull request #\d+\s+from\s+\S+\s*)/i, '')
    .replace(/^(?:build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(?:\([^)]*\))?!?:\s*/i, '')
    .trim();

  if (trimmedPrefix.length <= MAX_ACTIVITY_MESSAGE_LENGTH) {
    return trimmedPrefix;
  }

  return `${trimmedPrefix.slice(0, MAX_ACTIVITY_MESSAGE_LENGTH - 1).trimEnd()}‚Ä¶`;
};

const normalizeGithubEvent = (event: GithubEvent): NormalizedActivity | null => {
  const repo = event.repo?.name?.split('/')[1] ?? event.repo?.name;
  const date = event.created_at;

  if (!repo || !date) return null;

  if (event.type === 'PushEvent') {
    const message = event.payload?.commits?.[0]?.message;
    if (!message) return null;

    return {
      repo,
      message: normalizeMessage(message),
      link: `https://github.com/${event.repo?.name}`,
      date,
    };
  }

  if (event.type === 'PullRequestEvent') {
    const message = event.payload?.pull_request?.title;
    if (!message) return null;

    return {
      repo,
      message: normalizeMessage(message),
      link: event.payload?.pull_request?.html_url ?? `https://github.com/${event.repo?.name}`,
      date,
    };
  }

  if (event.type === 'CreateEvent') {
    const refType = event.payload?.ref_type;
    const refName = event.payload?.ref;
    const description = event.payload?.description;
    const message = description || `Created ${refType}${refName ? ` ${refName}` : ''}`;

    return {
      repo,
      message: normalizeMessage(message),
      link: `https://github.com/${event.repo?.name}`,
      date,
    };
  }

  return null;
};

async function getGithubActivity() {
  try {
    // In Vercel static mode this runs at build time, so GitHub API rate limits can fail the build and should be handled gracefully.
    const response = await fetch('https://api.github.com/users/JPClow3/events/public');

    if (!response.ok) return [];

    const events = (await response.json()) as GithubEvent[];

    const fallbackOrder: GithubEvent['type'][] = ['PushEvent', 'PullRequestEvent', 'CreateEvent'];
    const unique = new Set<string>();
    const normalized: NormalizedActivity[] = [];

    for (const type of fallbackOrder) {
      for (const event of events) {
        if (event.type !== type) continue;

        const activity = normalizeGithubEvent(event);
        if (!activity) continue;

        const key = `${activity.repo}:${activity.date}`;
        if (unique.has(key)) continue;

        unique.add(key);
        normalized.push(activity);
      }
    }

    return normalized.slice(0, 6);
  } catch {
    return [];
  }
}

await getGithubActivity();
---

<BaseLayout title="Jo√£o Paulo Gon√ßalves Santos - Portfolio" description="Personal portfolio of Jo√£o Paulo with projects, journey and GitHub updates.">
  <main class="noise-bg relative overflow-x-hidden px-4 pb-14 pt-6 sm:px-6 lg:px-8">
    <div class="pointer-events-none fixed inset-0 -z-10">
      <div class="bg-grid absolute inset-0 opacity-20"></div>
      <div class="absolute -right-24 -top-24 h-[420px] w-[420px] rounded-full bg-violet-600/25 blur-[120px]"></div>
      <div class="absolute -left-28 top-[48%] h-[400px] w-[400px] rounded-full bg-indigo-500/25 blur-[120px]"></div>
    </div>

    <div class="fixed left-0 right-0 top-5 z-50 flex justify-center px-4">
      <nav class="glass-panel flex items-center gap-1 rounded-full px-2 py-2 text-xs text-slate-200/90 sm:text-sm">
        <a href="#projects" class="flex items-center gap-1 rounded-full px-3 py-2 hover:bg-white/10"><span class="material-symbols-outlined text-base">code</span>Projects</a>
        <a href="#about" class="flex items-center gap-1 rounded-full px-3 py-2 hover:bg-white/10"><span class="material-symbols-outlined text-base">person</span>About</a>
        <a href="#contact" class="ml-1 flex items-center gap-1 rounded-full bg-[rgb(var(--primary))] px-4 py-2 font-semibold text-white">Say Hello<span class="material-symbols-outlined text-base">arrow_forward</span></a>
      </nav>
    </div>

    <div class="mx-auto max-w-7xl pt-24">
      <header id="about" class="mb-20 grid grid-cols-1 gap-10 lg:grid-cols-12">
        <div class="lg:col-span-7">
          <div class="mb-4 inline-flex items-center gap-2 text-sm uppercase tracking-wide text-[rgb(var(--primary))]">
            <span class="relative flex h-2.5 w-2.5">
              <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-green-400 opacity-75"></span>
              <span class="relative inline-flex h-2.5 w-2.5 rounded-full bg-green-500"></span>
            </span>
            Available for opportunities
          </div>
          <h1 class="text-5xl font-extrabold leading-[1.02] tracking-tight text-slate-100 md:text-6xl lg:text-7xl">
            I‚Äôm Jo√£o ‚Äî crafting
            <span class="text-gradient">beautiful, reliable</span>
            digital experiences.
          </h1>
          <p class="mt-6 max-w-2xl text-lg text-slate-300/80">{profile.subtitle}</p>
          <div class="mt-8 flex flex-wrap gap-3">
            <a href="#projects" class="rounded-full bg-white px-7 py-3 text-sm font-semibold text-slate-900">View Work</a>
            <a href={profile.github} target="_blank" rel="noreferrer" class="rounded-full border border-white/20 px-7 py-3 text-sm font-semibold text-white/90">GitHub Profile</a>
          </div>
        </div>

        <div class="flex flex-col gap-5 lg:col-span-5">
          <article class="glass-panel rounded-3xl p-7 text-center">
            <div class="mx-auto mb-3 flex h-20 w-20 items-center justify-center rounded-full bg-gradient-to-tr from-violet-500 to-indigo-500 text-3xl">üë®‚Äçüíª</div>
            <h2 class="text-2xl font-bold">{profile.shortName}</h2>
            <p class="text-sm text-[rgb(var(--primary))]">{profile.role}</p>
            <div class="mt-3 flex justify-center gap-2 text-xs">
              <span class="rounded-full border border-white/15 px-3 py-1">üáßüá∑ {profile.location}</span>
              <span class="rounded-full border border-white/15 px-3 py-1">{profile.timezone}</span>
            </div>
            <div class="mt-5 grid grid-cols-3 gap-2 border-t border-white/10 pt-5 text-center">
              <div><p class="text-lg font-bold">3+</p><p class="text-[10px] uppercase text-slate-400">Years</p></div>
              <div><p class="text-lg font-bold">20+</p><p class="text-[10px] uppercase text-slate-400">Projects</p></div>
              <div><p class="text-lg font-bold">100%</p><p class="text-[10px] uppercase text-slate-400">Commitment</p></div>
            </div>
          </article>

          <article class="glass-panel rounded-3xl p-6">
            <p class="mb-4 text-xs uppercase tracking-[0.2em] text-slate-400">Currently</p>
            <div class="space-y-4">
              {currentFocus.map((item) => (
                <div class="flex items-start gap-3">
                  <span class="material-symbols-outlined rounded-xl bg-white/5 p-2 text-base">{item.icon}</span>
                  <div>
                    <p class="text-[10px] uppercase tracking-[0.18em] text-slate-400">{item.label}</p>
                    <p class="text-sm text-slate-100">{item.value}</p>
                  </div>
                </div>
              ))}
            </div>
          </article>
        </div>
      </header>

      <section class="mb-20 overflow-hidden">
        <h3 class="mb-4 text-center text-xs font-bold uppercase tracking-[0.25em] text-slate-400">Technologies I work with</h3>
        <div class="marquee flex min-w-max gap-10 whitespace-nowrap py-3 text-3xl font-bold text-white/70">
          {[...techMarquee, ...techMarquee].map((tech) => (
            <span>{tech}</span>
          ))}
        </div>
      </section>

      <section id="projects" class="mb-20">
        <div class="mb-6 flex items-end justify-between">
          <h2 class="text-4xl font-bold tracking-tight">Things I‚Äôve been building</h2>
          <a href={`${profile.github}?tab=repositories`} target="_blank" rel="noreferrer" class="text-sm text-slate-400 hover:text-white">See all repos ‚Üí</a>
        </div>
        <div class="bento-grid">
          {projects.map((project, index) => (
            <article class:list={[
              'glass-panel rounded-3xl p-6 transition hover:border-[rgb(var(--primary))]/40',
              index === 0 ? 'bento-span-2' : '',
              index === 1 ? 'bento-row-span-2' : '',
            ]}>
              <h3 class="text-2xl font-bold">{project.data.title}</h3>
              <p class="mt-3 text-sm leading-relaxed text-slate-300/80">{project.data.description}</p>
              <div class="mt-4 flex flex-wrap gap-2">
                {project.data.tech.slice(0, 4).map((tech) => (
                  <span class="rounded-lg border border-white/15 bg-white/5 px-2.5 py-1 text-[10px]">{tech}</span>
                ))}
              </div>
              <div class="mt-5 flex gap-4 text-sm">
                {project.data.github && <a href={project.data.github} target="_blank" rel="noreferrer" class="font-semibold text-[rgb(var(--primary))]">View Project ‚Üó</a>}
                {project.data.link && <a href={project.data.link} target="_blank" rel="noreferrer" class="text-slate-300">Live ‚Üó</a>}
              </div>
            </article>
          ))}
        </div>
      </section>

      <section class="mb-20">
        <h2 class="mb-8 text-4xl font-bold tracking-tight">My journey so far</h2>
        <div class="timeline relative space-y-8 pl-8">
          {experience.map((job, idx) => (
            <article class="glass-panel relative rounded-2xl p-6">
              <span class:list={[
                'absolute -left-[31px] top-7 h-5 w-5 rounded-full border-4 border-[#120f23]',
                idx === 0 ? 'bg-[rgb(var(--primary))]' : 'bg-slate-500',
              ]}></span>
              <div class="mb-3 flex flex-col justify-between gap-2 sm:flex-row sm:items-center">
                <div>
                  <h3 class="text-xl font-bold">{job.data.role}</h3>
                  <p class="text-[rgb(var(--primary))]">{job.data.company}</p>
                </div>
                <span class="rounded-full border border-white/15 px-3 py-1 text-xs text-slate-300">{formatDate(job.data.startDate)} ‚Äî {job.data.endDate ? formatDate(job.data.endDate) : 'Present'}</span>
              </div>
              <ul class="list-disc space-y-1 pl-5 text-sm text-slate-300/80 marker:text-[rgb(var(--primary))]">
                {job.data.tasks.slice(0, 2).map((task) => (
                  <li>{task}</li>
                ))}
              </ul>
            </article>
          ))}
        </div>
      </section>

      <section class="mb-20">
        <div class="mb-6 flex items-end justify-between">
          <h2 class="text-3xl font-bold">Commit History</h2>
          <a href={profile.github} target="_blank" rel="noreferrer" class="text-sm text-slate-400 hover:text-white">View full profile ‚Üó</a>
        </div>
        <div class="glass-panel overflow-hidden rounded-2xl">
          {recentGithubActivity.map((event) => (
            <a href={event.url} target="_blank" rel="noreferrer" class="flex items-center justify-between gap-4 border-b border-white/10 p-4 last:border-0 hover:bg-white/5">
              <div>
                <p class="text-xs font-bold uppercase tracking-[0.18em] text-[rgb(var(--primary))]">{event.repo}</p>
                <p class="text-sm text-slate-200/90">{event.message}</p>
              </div>
              <span class="text-xs text-slate-400">{event.date}</span>
            </a>
          ))}
        </div>
      </section>

      <footer id="contact" class="glass-panel mb-8 flex flex-col items-center justify-between gap-6 rounded-3xl p-10 text-center md:flex-row md:text-left">
        <div>
          <p class="mb-2 inline-block rounded-full border border-[rgb(var(--primary))]/40 bg-[rgb(var(--primary))]/20 px-3 py-1 text-xs font-bold uppercase tracking-[0.18em] text-[rgb(var(--primary))]">Let‚Äôs Connect</p>
          <h2 class="text-4xl font-bold">Have a project in mind?</h2>
          <a class="mt-2 block text-xl text-slate-300 hover:text-white" href={`mailto:${profile.email}`}>{profile.email}</a>
        </div>
        <div class="flex flex-wrap gap-3">
          <a href={`mailto:${profile.email}`} class="rounded-full bg-[rgb(var(--primary))] px-7 py-3 text-sm font-bold text-white">Say hello</a>
          <a href={profile.linkedin} target="_blank" rel="noreferrer" class="rounded-full border border-white/15 px-7 py-3 text-sm font-bold text-slate-100">LinkedIn ‚Üó</a>
        </div>
      </footer>
    </div>
  </main>
</BaseLayout>
